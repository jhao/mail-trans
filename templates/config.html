<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>邮件汇总系统 - 配置</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <header>
    <h1>系统配置</h1>
    <nav>
      <a href="{{ url_for('index') }}">首页</a> |
      <a href="{{ url_for('config_page') }}">配置</a> |
      <a href="{{ url_for('logs_page') }}">日志</a>
    </nav>
  </header>
  <main>
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <ul class="flash-messages">
        {% for message in messages %}
          <li>{{ message }}</li>
        {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}
    <form method="post" class="config-form">
      <h2>IMAP 邮箱配置</h2>
      <label>IMAP 服务器地址：<input type="text" name="imap_host" value="{{ config.get('imap_host','') }}"></label>
      <label>IMAP 端口：<input type="text" name="imap_port" value="{{ config.get('imap_port','993') }}"></label>
      <label>邮箱账号：<input type="text" name="imap_user" value="{{ config.get('imap_user','') }}"></label>
      <label>邮箱密码/授权码：<input type="password" name="imap_pass" value="{{ config.get('imap_pass','') }}"></label>
      <label>读取邮箱文件夹：
        {% if mailboxes %}
          <select name="imap_mailbox">
            <option value="" disabled {% if not config.get('imap_mailbox') %}selected{% endif %}>请选择邮箱文件夹</option>
            {% for mailbox in mailboxes %}
              <option value="{{ mailbox }}" {% if mailbox == config.get('imap_mailbox') %}selected{% endif %}>{{ mailbox }}</option>
            {% endfor %}
          </select>
        {% else %}
          <input type="text" name="imap_mailbox" value="{{ config.get('imap_mailbox','') }}">
          <small class="hint">尚未获取邮箱列表，可先填写名称或点击下方按钮验证后选择。</small>
        {% endif %}
      </label>
      <h3>IMAP 客户端标识（ID 命令，可选）</h3>
      <p class="hint">当服务器要求提供 IMAP ID 信息时，可在此设置客户端名称、版本等标识以避免 Unsafe Login。</p>
      <label>客户端名称（name）：<input type="text" name="imap_id_name" value="{{ config.get('imap_id_name') or default_imap_id['name'] }}"></label>
      <label>客户端版本（version）：<input type="text" name="imap_id_version" value="{{ config.get('imap_id_version') or default_imap_id['version'] }}"></label>
      <label>客户端供应商（vendor）：<input type="text" name="imap_id_vendor" value="{{ config.get('imap_id_vendor') or default_imap_id['vendor'] }}"></label>
      <label>支持页面（support-url）：<input type="url" name="imap_id_support_url" value="{{ config.get('imap_id_support_url') or default_imap_id['support-url'] }}"></label>
      <label>支持邮箱（support-email）：<input type="email" name="imap_id_support_email" value="{{ config.get('imap_id_support_email','') }}"></label>
      <div class="form-actions inline">
        <button type="button" id="restore-imap-id-defaults">恢复默认值</button>
      </div>
      <h2>SMTP 发件配置</h2>
      <label>SMTP 服务器地址：<input type="text" name="smtp_host" value="{{ config.get('smtp_host','') }}"></label>
      <label>SMTP 端口：<input type="text" name="smtp_port" value="{{ config.get('smtp_port','465') }}"></label>
      <label>SMTP 用户名：<input type="text" name="smtp_user" value="{{ config.get('smtp_user','') }}"></label>
      <label>SMTP 密码/授权码：<input type="password" name="smtp_pass" value="{{ config.get('smtp_pass','') }}"></label>
      <h2>邮件规则与目标</h2>
      <label>转发到邮箱：<input type="email" name="forward_email" value="{{ config.get('forward_email','') }}"></label>
      <label>发件人筛选（逗号分隔）：<input type="text" name="senders" placeholder="例如: sender1@example.com,sender2@163.com" value="{{ config.get('senders','') }}"></label>
      <h2>DeepSeek 配置</h2>
      <label>DeepSeek Token：<input type="text" name="deepseek_token" value="{{ config.get('deepseek_token','') }}"></label>
      <div class="form-actions">
        <button type="submit" name="action" value="save">保存配置</button>
        <button type="submit" name="action" value="fetch_mailboxes">验证并获取邮箱列表</button>
      </div>
    </form>
  </main>
  <footer>
    <p>&copy; 2025 邮件汇总系统</p>
  </footer>
  <script>
    window.addEventListener('DOMContentLoaded', function () {
      const defaultImapId = {{ default_imap_id | tojson }};
      const restoreButton = document.getElementById('restore-imap-id-defaults');
      if (restoreButton) {
        restoreButton.addEventListener('click', function () {
          const mappings = {
            name: 'imap_id_name',
            version: 'imap_id_version',
            vendor: 'imap_id_vendor',
            'support-url': 'imap_id_support_url',
          };
          Object.entries(mappings).forEach(function ([key, inputName]) {
            const input = document.querySelector(`input[name="${inputName}"]`);
            if (input && defaultImapId[key]) {
              input.value = defaultImapId[key];
            }
          });
        });
      }
    });
  </script>
  {% if fetched_mailboxes %}
  <script>
    window.addEventListener('DOMContentLoaded', function () {
      const mailboxes = {{ fetched_mailboxes | tojson }};
      const message = mailboxes.length ? mailboxes.join('\n') : '未获取到任何邮箱文件夹。';
      alert('成功获取邮箱文件夹列表：\n' + message);
    });
  </script>
  {% endif %}
</body>
</html>
