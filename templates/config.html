<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>邮件汇总系统 - 配置</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <header>
    <h1>系统配置</h1>
    <nav>
      <a href="{{ url_for('index') }}">首页</a> |
      <a href="{{ url_for('config_page') }}">配置</a> |
      <a href="{{ url_for('logs_page') }}">日志</a>
      {% if current_user %}
      | <span class="user-info">当前用户：{{ current_user }}</span>
      | <a href="{{ url_for('logout') }}">退出</a>
      {% endif %}
    </nav>
  </header>
  <main>
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <ul class="flash-messages">
        {% for message in messages %}
          <li>{{ message }}</li>
        {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}
    <form method="post" class="config-form">
      {% set current_protocol = (config.get('mail_protocol') or 'imap').lower() %}
      <h2>邮件接收协议</h2>
      <label>选择协议：
        <select name="mail_protocol">
          <option value="imap" {% if current_protocol != 'pop3' %}selected{% endif %}>IMAP</option>
          <option value="pop3" {% if current_protocol == 'pop3' %}selected{% endif %}>POP3</option>
        </select>
      </label>
      <p class="hint">切换协议后请保存配置以生效。</p>

      <h2>IMAP 邮箱配置</h2>
      <p class="hint">仅在选择 IMAP 协议时生效。</p>
      <label>IMAP 服务器地址：<input type="text" name="imap_host" value="{{ config.get('imap_host','') }}"></label>
      <label>IMAP 端口：<input type="text" name="imap_port" value="{{ config.get('imap_port','993') }}"></label>
      <label>邮箱账号：<input type="text" name="imap_user" value="{{ config.get('imap_user','') }}"></label>
      <label>邮箱密码/授权码：<input type="password" name="imap_pass" value="{{ config.get('imap_pass','') }}"></label>
      {% if current_protocol == 'imap' %}
      <label>读取邮箱文件夹：
        {% if mailboxes %}
          <select name="imap_mailbox">
            <option value="" disabled {% if not config.get('imap_mailbox') %}selected{% endif %}>请选择邮箱文件夹</option>
            {% for mailbox in mailboxes %}
              <option value="{{ mailbox }}" {% if mailbox == config.get('imap_mailbox') %}selected{% endif %}>{{ mailbox }}</option>
            {% endfor %}
          </select>
        {% else %}
          <input type="text" name="imap_mailbox" value="{{ config.get('imap_mailbox','') }}">
          <small class="hint">尚未获取邮箱列表，可先填写名称或点击下方按钮验证后选择。</small>
        {% endif %}
      </label>
      {% else %}
      <label>读取邮箱文件夹（IMAP 专用）：
        <input type="text" name="imap_mailbox" value="{{ config.get('imap_mailbox','') }}">
        <small class="hint">当前选择 POP3，此设置将被忽略。</small>
      </label>
      {% endif %}
      <h3>IMAP 客户端标识（ID 命令，可选）</h3>
      <p class="hint">当服务器要求提供 IMAP ID 信息时，可在此设置客户端名称、版本等标识以避免 Unsafe Login。</p>
      <label>客户端名称（name）：<input type="text" name="imap_id_name" value="{{ config.get('imap_id_name') or default_imap_id['name'] }}"></label>
      <label>客户端版本（version）：<input type="text" name="imap_id_version" value="{{ config.get('imap_id_version') or default_imap_id['version'] }}"></label>
      <label>客户端供应商（vendor）：<input type="text" name="imap_id_vendor" value="{{ config.get('imap_id_vendor') or default_imap_id['vendor'] }}"></label>
      <label>支持页面（support-url）：<input type="url" name="imap_id_support_url" value="{{ config.get('imap_id_support_url') or default_imap_id['support-url'] }}"></label>
      <label>支持邮箱（support-email）：<input type="email" name="imap_id_support_email" value="{{ config.get('imap_id_support_email','') }}"></label>
      <div class="form-actions inline">
        <button type="button" id="restore-imap-id-defaults">恢复默认值</button>
      </div>

      <h2>POP3 邮箱配置</h2>
      <p class="hint">仅在选择 POP3 协议时生效。</p>
      <label>POP3 服务器地址：<input type="text" name="pop3_host" value="{{ config.get('pop3_host','') }}"></label>
      <label>POP3 端口：<input type="text" name="pop3_port" value="{{ config.get('pop3_port','995') }}"></label>
      <label>邮箱账号：<input type="text" name="pop3_user" value="{{ config.get('pop3_user','') }}"></label>
      <label>邮箱密码/授权码：<input type="password" name="pop3_pass" value="{{ config.get('pop3_pass','') }}"></label>
      <label>使用 SSL（995 推荐）：
        {% set pop3_ssl_value = config.get('pop3_use_ssl', 'true') %}
        {% if pop3_ssl_value is string %}
          {% set pop3_ssl_flag = pop3_ssl_value.lower() %}
        {% else %}
          {% set pop3_ssl_flag = 'true' if pop3_ssl_value else 'false' %}
        {% endif %}
        <input type="checkbox" name="pop3_use_ssl" value="true" {% if pop3_ssl_flag not in ['false', '0', 'no', 'off'] %}checked{% endif %}>
        <small class="hint">取消勾选将使用明文连接，谨慎操作。</small>
      </label>
      <h2>SMTP 发件配置</h2>
      <label>SMTP 服务器地址：<input type="text" name="smtp_host" value="{{ config.get('smtp_host','') }}"></label>
      <label>SMTP 端口：<input type="text" name="smtp_port" value="{{ config.get('smtp_port','465') }}"></label>
      <label>SMTP 用户名：<input type="text" name="smtp_user" value="{{ config.get('smtp_user','') }}"></label>
      <label>SMTP 密码/授权码：<input type="password" name="smtp_pass" value="{{ config.get('smtp_pass','') }}"></label>
      <h2>邮件规则与目标</h2>
      <label>转发到邮箱：<input type="email" name="forward_email" value="{{ config.get('forward_email','') }}"></label>
      <label>发件人筛选（逗号分隔）：<input type="text" name="senders" placeholder="例如: sender1@example.com,sender2@163.com" value="{{ config.get('senders','') }}"></label>
      <h2>DeepSeek 配置</h2>
      <label>DeepSeek Token：<input type="text" name="deepseek_token" value="{{ config.get('deepseek_token','') }}"></label>
      {% set timeout_value = config.get('deepseek_timeout') %}
      <label>DeepSeek 请求超时时间（秒）：
        <input type="number" name="deepseek_timeout" min="10" max="600" value="{{ timeout_value if timeout_value else deepseek_timeout_default }}">
      </label>
      <p class="hint">翻译接口响应较慢时，可在此延长等待时间。默认值为 {{ deepseek_timeout_default }} 秒。</p>
      <div class="form-actions">
        <button type="submit" name="action" value="save">保存配置</button>
        {% if current_protocol != 'pop3' %}
        <button type="submit" name="action" value="fetch_mailboxes">验证并获取邮箱列表</button>
        {% endif %}
      </div>
    </form>
    <section class="auth-settings">
      <h2>登录密码管理</h2>
      <p class="hint">修改后立即生效，与启动参数 <code>--pwd</code> 无关。</p>
      <form method="post" class="auth-form inline">
        <label>新密码
          <input type="password" name="new_password" required>
        </label>
        <label>确认新密码
          <input type="password" name="confirm_password" required>
        </label>
        <div class="form-actions">
          <button type="submit" name="action" value="update_password">更新密码</button>
        </div>
      </form>
    </section>
  </main>
  <footer>
    <p>&copy; 2025 邮件汇总系统</p>
  </footer>
  <script>
    window.addEventListener('DOMContentLoaded', function () {
      const defaultImapId = {{ default_imap_id | tojson }};
      const restoreButton = document.getElementById('restore-imap-id-defaults');
      if (restoreButton) {
        restoreButton.addEventListener('click', function () {
          const mappings = {
            name: 'imap_id_name',
            version: 'imap_id_version',
            vendor: 'imap_id_vendor',
            'support-url': 'imap_id_support_url',
          };
          Object.entries(mappings).forEach(function ([key, inputName]) {
            const input = document.querySelector(`input[name="${inputName}"]`);
            if (input && defaultImapId[key]) {
              input.value = defaultImapId[key];
            }
          });
        });
      }
    });
  </script>
  {% if fetched_mailboxes %}
  <script>
    window.addEventListener('DOMContentLoaded', function () {
      const mailboxes = {{ fetched_mailboxes | tojson }};
      const message = mailboxes.length ? mailboxes.join('\n') : '未获取到任何邮箱文件夹。';
      alert('成功获取邮箱文件夹列表：\n' + message);
    });
  </script>
  {% endif %}
</body>
</html>
